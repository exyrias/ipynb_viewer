<!DOCTYPE html>
<html>

<head>
  <title>ipynb Viewer</title>
  <style type="text/css">
    .cell {
      display: flex;
      flex-direction: column;
    }
    .input {
      display: flex;
    }
    .output {
      display: flex;
    }
    .prompt {
      font-size: 12px;
      text-align: right;
      margin: 5px;
      padding: 3px;
      width: 90px;
      flex-shrink: 0;
    }
    .box {
      margin: 5px;
      padding: 3px;
    }
    .code {
      background-color: rgb(247, 247, 247);
      border: solid;
      border-radius: 2px;
      border-color: rgb(207, 207, 207);
      border-width: 1px;
      flex-grow: 1;
    }
    .output-holder {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    .outputtable table {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        margin-left: 0;
        margin-right: 0;
        border: none;
        border-collapse: collapse;
        border-spacing: 0;
        color: black;
        font-size: 12px;
        table-layout: fixed;
    }
    .outputtable thead {
        border-bottom: 1px solid black;
    }
    .outputtable tr, .outputtable th, .outputtable td {
        text-align: right;
        padding: 0.5em 0.5em;
    }
    .outputtable tbody tr:nth-child(odd) {
        background: rgb(245, 245, 245);
    }
  </style>
</head>

<body>
  <input type="file" id="inputfile" />
  <div id="imgarea"></div>
  <script>
    const createPrompt = ((type, num) => {
      let elm = document.createElement("pre");
      elm.className = "prompt";
      num = (num === null) ? "" : num;
      elm.innerHTML = (type === "in" ? "In " : "Out") + "[" + num + "]";
      return elm;
    });

    const createInput = ((cell) => {
      let elm_input = document.createElement("div");
      elm_input.className = "input";

      // prompt ( In [_], Out[] )
      elm_input.appendChild(createPrompt("in", cell.execution_count));

      // code block
      let elm_source = document.createElement("pre");
      elm_source.className = "code box";
      elm_source.innerHTML = cell.source.join("");
      elm_input.appendChild(elm_source);

      return elm_input;
    });

    const createOutputText = ((dat) => {
      let elm = document.createElement("pre");
      elm.className = "outputtext box";
      elm.innerHTML = dat.text.join("");
      return elm;
    });

    const createOutputImage = ((dat) => {
      let elm = document.createElement("div");
      elm.className = "outputimg box";

      // create size changer button
      let elm_small_btn = document.createElement("button");
      let elm_big_btn = document.createElement("button");
      elm_small_btn.innerHTML = "-";
      elm_big_btn.innerHTML = "+";
      elm.appendChild(elm_small_btn);
      elm.appendChild(elm_big_btn);
      elm.appendChild(document.createElement("br"));

      // append image
      let elm_output_img = document.createElement("img");
      let src="data:image/png;base64,";
      src += dat.data["image/png"];
      elm_output_img.src = src;
      elm.appendChild(elm_output_img);

      // function: change size
      elm_small_btn.addEventListener('click', () => {
        let scale = elm_output_img.width / elm_output_img.naturalWidth;
        scale = scale < 0.1 ? scale : scale - 0.1;
        elm_output_img.width = scale * elm_output_img.naturalWidth;
        elm_output_img.height = scale * elm_output_img.naturalHeight;
      });
      elm_big_btn.addEventListener('click', () => {
        let scale = elm_output_img.width / elm_output_img.naturalWidth;
        scale = scale > 10 ? scale : scale + 0.1;
        elm_output_img.width = scale * elm_output_img.naturalWidth;
        elm_output_img.height = scale * elm_output_img.naturalHeight;
      });

      return elm;
    });

    const createOutputHtmlResult = ((dat) => {
      let elm = document.createElement("div");
      elm.className = "outputtable box";
      elm.innerHTML = dat.data['text/html'].join(""); // plain text
      return elm;
    });

    const createOutputTextResult = ((dat) => {
      let elm = document.createElement("pre");
      elm.className = "outputtext box";
      elm.innerHTML = dat.data['text/plain'].join(""); // plain text
      return elm;
    });

    const createOutput = ((cell) => {
      let elm_output = document.createElement("div");
      elm_output.className = "output";

      if (cell.outputs.length > 0) {
        // prompt
        elm_output.appendChild(createPrompt("out", cell.execution_count));

        // output holder
        let elm_output_holder = document.createElement("div");
        elm_output_holder.className = "output-holder";
        elm_output.appendChild(elm_output_holder);

        cell.outputs.forEach(dat => {
          if (dat.output_type === "stream") {
            elm_output_holder.appendChild(createOutputText(dat));
          }
          else if (dat.output_type === "display_data"){
            elm_output_holder.appendChild(createOutputImage(dat));
          }
          else if (dat.output_type == "execute_result"){
            if (dat.data['text/html'] !== undefined) {
              elm_output_holder.appendChild(createOutputHtmlResult(dat));
            }
            else {
              elm_output_holder.appendChild(createOutputTextResult(dat));
            }
          }
        });
      }

      return elm_output;
    });

    const createCell = ((cell) => {
      const elm_cell = document.createElement("div");
      elm_cell.className = "cell";
      elm_cell.appendChild(createInput(cell));
      elm_cell.appendChild(createOutput(cell));
      return elm_cell;
    });

    let inputFile = document.getElementById('inputfile');
    let div = document.getElementById('imgarea');
    inputFile.addEventListener('change', (e) => {
      // reset div
      while (div.firstChild) {
        div.removeChild(div.firstChild);
      }

      let reader = new FileReader();
      reader.readAsText(e.target.files[0]);

      reader.onload = () => {
        let cells = JSON.parse(reader.result).cells;

        cells.forEach(cell => {
          div.appendChild(createCell(cell));
        });
      };
    }, false);

  </script>
</body>

</html>
